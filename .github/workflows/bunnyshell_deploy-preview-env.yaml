name: Bunnyshell - Deploy Preview Environment
on:
  workflow_run:
    workflows:
      - "Bunnyshell - Prepare Preview Environment Configuration"
    types:
      - completed
permissions:
  pull-requests: write
jobs:
  load-artifact-from-reusable:
    name: Load artifact values
    uses: bunnyshell/workflows/.github/workflows/load-artifact.yaml@v2
    with:
      workflow_run_id: ${{ github.event.workflow_run.id }}

  deploy:
    name: Deploy Environment
    needs: load-artifact-from-reusable
    uses: bunnyshell/workflows/.github/workflows/deploy-env.yaml@v2
    concurrency: bns-deploy-${{ needs.load-artifact-from-reusable.outputs.pr-number }}
    if: ${{ github.event.workflow_run.conclusion == 'success' && needs.load-artifact-from-reusable.outputs.skip-deployment == 'false' }}
    with:
      pr-number: ${{ needs.load-artifact-from-reusable.outputs.pr-number }}
      project-id: "y6X3V6nwO8"
      cluster-id: "pDM8476MJx"
      env-name: "Demo PR #${{ needs.load-artifact-from-reusable.outputs.pr-number }}"
      bunnyshell-yaml-contents: "kind: Environment name: preview type: primary urlHandle: 227poy components: - kind: Application name: todo-app gitRepo: 'https://github.com/Ivan0348/DevOps.git' gitBranch: main gitApplicationPath: week4/DockerVolumeTest/multi-container-app/app dockerCompose: build: context: ./week4/DockerVolumeTest/multi-container-app/app dockerfile: Dockerfile environment: NODE_ENV: production ports: - '3000:3000' - '35729:35729' hosts: - hostname: 'todo-app-{{ env.base_domain }}' path: / servicePort: 3000 - kind: Database name: todo-database dockerCompose: image: 'mongo:6' ports: - '27017:27017' volumes: - name: database mount: /data/db subPath: '' volumes: - name: database size: 1Gi type: disk"
      comment-on-pr: true
    secrets:
      bunnyshell-access-token: ${{ secrets.BUNNYSHELL_TOKEN }}